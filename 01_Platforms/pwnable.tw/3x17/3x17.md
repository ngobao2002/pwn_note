https://github.com/smokeleeteveryday/CTF_WRITEUPS/tree/master/2016/CODEGATE/pwnable/oldschool
Kĩ thuật overwrite .fini
`.fini_array` section là 1 vùng trong binary cung cấp các hàm deconstructor cần thiết cho quá trình kết thúc chương trình sau khi hàm main() return. Ngược với `.init_array` section là vùng cung cấp các hàm constructor cần thiết cho quá trình khởi tạo trước khi thực hiện hàm main()
`.fini_array` section gồm 2 entry:
- `_do_global_dtors_aux`: các destructors xử lý khi `.fini_array` ko được xác định.
- `foo_destructor`: địa chỉ của hàm destructor.
Chương trình gọi 2 hàm trên theo thứ tự từ dưới lên, nghĩa là gọi `foo_destructor` trước rồi mới đến `_do_global_dtors_aux`.
![[Pasted image 20250909145513.png]]

![[Pasted image 20250909144142.png]]
Chúng ta thấy rằng khi nhập nhiều dữ liệu trong data thì chương trình sẽ tự động tắt chương trình. Vậy có phải buffer overflow?
Chính nhờ những kiến thức bên trên, thì ta sẽ có cách solve chall này như sau:
- ghi đè địa chỉ của .fini_array = địa chỉ của foo_destructor và địa chỉ của main => khi chạy hết main, chương trình sẽ nhảy vào foo_destructor sau đó quay lại main => chúng ta có thể ghi đi ghi lại nhiều lần tuỳ ý
- build stack bằng ROP
Xác định địa chỉ của .fini_array trong ida pro:
shitt + f7 => tìm kiếm .fini_array
![[Pasted image 20250909150531.png]]
![[Pasted image 20250909150656.png]]
Ta xác định được 3 địa chỉ:
- .fini_array : 0x4b40f0
- foo_destructor: 0x402960
- main: 0x401b6d
jump to address: press G và nhập địa chỉ cần nhảy  tới
Như vậy ta có thể ghi đè vào vị trí của `.fini_array` payload như sau:
_**payload = p64(0x402960) + p64(0x401b6d)**_

![[Pasted image 20250909153006.png]]


#### References
https://drx.home.blog/2019/04/17/pwnable-tw-3x17/
http://www.bright-shadows.net/tutorials/dtors.txt
https://vuotnh.hashnode.dev/3x17-pwnabletw